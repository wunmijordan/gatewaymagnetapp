{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}

<div class="page-wrapper">
  <!-- BEGIN PAGE HEADER -->
  <div class="page-header d-print-none" aria-label="Page header">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Dynamic Page Title -->
          <kbd class="bg-success-lt"><h2 class="page-title">{{ page_title }}</h2></kbd>
        </div>

        <!-- Page title actions -->
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <div>
              <!-- Single Button for Regular Users -->
              <a href="#" class="btn btn-gray d-none d-sm-inline-block" aria-label="Add programme" data-bs-toggle="modal" data-bs-target="#eventModal" id="addEventBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12.5 21h-6.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5" />
                  <path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M16 19h6" /><path d="M19 16v6" />
                </svg>
                Add Programme
              </a>

              <!-- Mobile Button -->
              <a href="#" class="btn btn-gray d-sm-none btn-icon" aria-label="Add programme" data-bs-toggle="modal" data-bs-target="#eventModal" id="addEventBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12.5 21h-6.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5" />
                  <path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M16 19h6" /><path d="M19 16v6" />
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>   
  </div>
  <!-- END PAGE HEADER -->
  <div class="page-body">
    <div class="container-xl">

      <div class="card bg-dark text-light shadow-sm p-4 rounded-3">
        <!-- Events List -->

        <h4 class="mb-3">Active Events</h4>
        <ul id="eventList" class="list-group bg-gray" style="max-height: 60vh; overflow-y: auto;">
          {% for event in events %}
            {% include "accounts/partials/event_item.html" %}
          {% empty %}
            <li class="list-group-item bg-gray text-white text-center">No events yet.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-0 rounded-3 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="modalTitle">Add Event</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="eventForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            {% for field in form %}
              {% if field.field.widget.input_type == "checkbox" %}
                <div class="col-md-6 form-check mt-4 ms-2">
                  {% render_field field class="form-check-input" %}
                  <label class="form-check-label text-light ms-2" for="{{ field.id_for_label }}">
                    {{ field.label }}
                  </label>
                </div>
              {% else %}
                <div class="col-md-6">
                  <label class="form-label text-light">{{ field.label }}</label>
                  {% render_field field class="form-control bg-gray text-light border-0" %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
  <div id="toast" class="toast align-items-center text-white bg-dark border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">Action completed.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalEl = document.getElementById("eventModal");
  const modal = new bootstrap.Modal(modalEl);
  const form = document.getElementById("eventForm");
  const eventList = document.getElementById("eventList");
  const toastEl = document.getElementById("toast");
  const toastMessage = document.getElementById("toastMessage");
  const toast = new bootstrap.Toast(toastEl);
  const addBtn = document.getElementById("addEventBtn");
  let editMode = false;
  let editId = null;

  // Reset modal for new event
  addBtn.addEventListener("click", () => {
    editMode = false;
    editId = null;
    document.getElementById("modalTitle").textContent = "Add Event";
    form.reset();
  });

  // Handle edit button
  eventList.addEventListener("click", (e) => {
    if (e.target.closest(".edit-btn")) {
      const btn = e.target.closest(".edit-btn");
      editMode = true;
      editId = btn.dataset.id;

      document.getElementById("modalTitle").textContent = "Edit Event";
      form.querySelector("[name='name']").value = btn.dataset.name;
      form.querySelector("[name='event_type']").value = btn.dataset.event_type;
      form.querySelector("[name='date']").value = btn.dataset.date;
      form.querySelector("[name='end_date']").value = btn.dataset.end_date || "";
      form.querySelector("[name='time']").value = btn.dataset.time || "";
      form.querySelector("[name='duration_days']").value = btn.dataset.duration_days;
      form.querySelector("[name='is_active']").checked = btn.dataset.is_active === "true";
      modal.show();
    }
  });

  // Handle delete
  eventList.addEventListener("click", async (e) => {
    if (e.target.closest(".delete-btn")) {
      e.preventDefault();
      const btn = e.target.closest(".delete-btn");
      if (!confirm("Delete this event?")) return;

      const res = await fetch(`/accounts/delete-event/${btn.dataset.id}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
      });
      if (res.ok) {
        btn.closest("li").remove();
        showToast("üóëÔ∏è Event deleted successfully");
      }
    }
  });

  // Handle form submit (AJAX)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const url = editMode
      ? `/accounts/edit-event/${editId}/`
      : `{% url 'accounts:manage_events' %}`;

    const res = await fetch(url, {
      method: "POST",
      body: formData,
    });

    const data = await res.json();
    if (res.ok && data.html) {
      if (editMode) {
        document.querySelector(`li[data-id='${editId}']`).outerHTML = data.html;
        showToast("‚úèÔ∏è Event updated successfully");
      } else {
        eventList.insertAdjacentHTML("beforeend", data.html);
        showToast("‚úÖ Event added successfully");
      }
      modal.hide();
      form.reset();
    } else {
      showToast("‚ö†Ô∏è Error saving event");
    }
  });

  function showToast(message) {
    toastMessage.textContent = message;
    toast.show();
  }
});
</script>
{% endblock %}
