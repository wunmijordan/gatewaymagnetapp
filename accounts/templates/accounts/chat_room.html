{% extends 'base.html' %}
{% load group_tags %}
{% load static %}
{% load humanize %}
{% block content %}

<div class="page-wrapper">
  <!-- BEGIN PAGE HEADER -->
  <div class="page-header d-print-none" aria-label="Page header">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Dynamic Page Title -->
          <kbd class="bg-indigo-lt"><h2 class="page-title">{{ page_title }}</h2></kbd>
        </div>
      </div>
    </div>
  </div>
  <!-- END PAGE HEADER -->

  <div class="page-body">
    <div class="container-xl flex-fill d-flex flex-column">
      <div class="card flex-fill">
        <div class="row g-0 flex-fill">
          <!-- LEFT COLUMN -->
          <div class="col-12 col-lg-5 col-xl-3 border-end d-flex flex-column">
            <div class="card-header mb-2 justify-content-center align-items-center border-0">
              <!-- Avatar -->
              <span class="avatar avatar-lg bg-purple-lt d-flex align-items-center justify-content-center" style="width:40px; height:40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-armchair">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M5 11a2 2 0 0 1 2 2v2h10v-2a2 2 0 1 1 4 0v4a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-4a2 2 0 0 1 2 -2z" />
                  <path d="M5 11v-5a3 3 0 0 1 3 -3h8a3 3 0 0 1 3 3v5" />
                  <path d="M6 19v2" /><path d="M18 19v2" />
                </svg>
              </span>

              <!-- Text -->
              <kbd class="ms-2 bg-warning-lt"><h5>A People <em>Helped</em> By God!</h5></kbd>
            </div>
            <div class="card-body p-0 mt-0 mb-3 scrollable flex-fill" style="height: 500px; overflow-y: auto;">
              <div class="row g-2">
                {% for user in users %}
                  <div class="col-12">
                    <div class="card shadow-sm ms-2 me-2 border-0 {{ user.color }}">
                      <div class="card-body py-2 px-3 d-flex align-items-center">
                        <!-- Avatar -->
                        <div class="me-3">
                          <a href="tel:{{ user.phone_number }}">
                            {% if user.image %}
                              <span class="avatar rounded"
                                    style="background-image:url('{{ user.image }}');
                                          width:40px; height:40px;
                                          background-size:cover;
                                          background-position:center;">
                              </span>
                            {% else %}
                              <span class="avatar d-flex align-items-center justify-content-center rounded text-white fw-bold"
                                    style="width:40px; height:40px; font-size:0.9rem;">
                                {{ user.initials }}
                              </span>
                            {% endif %}
                          </a>
                        </div>
                        <!-- Name + Last Message -->
                        <div class="flex-grow-1">
                          <div class="fw-bold text-truncate" style="color: var(--tblr-{{ user.color }});">
                            {{ user.title|default:"" }} {{ user.full_name }}
                          </div>
                          <div id="last-message-{{ user.id }}"
                                class="text-secondary fst-italic text-truncate" 
                                style="font-size:0.65rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ user.last_message|default:"No messages yet"|truncatechars:30 }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN -->
          <div class="col-12 col-lg-7 col-xl-9 d-flex flex-column">
            <div class="card-header justify-content-center border-0">
              <div class="input-icon">
                <span class="input-icon-addon">
                  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-user-search">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h1.5" />
                    <path d="M18 18m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" /><path d="M20.2 20.2l1.8 1.8" />
                  </svg>
                </span>
                <input type="text" id="chatSearch" class="form-control" 
                      placeholder="Search Chat" aria-label="Search">
              </div>
            </div>
            <div class="card-body mt-0 p-0 d-flex flex-column flex-fill">
              <!-- Chat Container -->
              <div class="chat-bubbles text-start ps-3 pe-2" id="chatMessagesContainer" style="overflow-y:auto; height:500px; position:relative; overflow-x:hidden;">
                <!-- Messages will be dynamically loaded here -->
              </div>
              <!-- Options Panel -->
              <div id="chatOptionsPanel" class="options-panel hidden" aria-hidden="true">
                <button id="replyBtn" title="Reply">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#ff5e01ff" class="bi bi-reply-all-fill" viewBox="0 0 16 16">
                    <path d="M8.021 11.9 3.453 8.62a.72.72 0 0 1 0-1.238L8.021 4.1a.716.716 0 0 1 1.079.619V6c1.5 0 6 0 7 8-2.5-4.5-7-4-7-4v1.281c0 .56-.606.898-1.079.62z"/>
                    <path d="M5.232 4.293a.5.5 0 0 1-.106.7L1.114 7.945l-.042.028a.147.147 0 0 0 0 .252l.042.028 4.012 2.954a.5.5 0 1 1-.593.805L.539 9.073a1.147 1.147 0 0 1 0-1.946l3.994-2.94a.5.5 0 0 1 .699.106"/>
                  </svg>
                </button>
                <!--<button id="editBtn" title="Edit">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                    <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z"/>
                  </svg>
                </button>-->
                <button id="copyBtn" title="Copy">
                  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="#02bd12ff"  class="icon icon-tabler icons-tabler-filled icon-tabler-copy-check">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M18.333 6a3.667 3.667 0 0 1 3.667 3.667v8.666a3.667 3.667 0 0 1 -3.667 3.667h-8.666a3.667 3.667 0 0 1 -3.667 -3.667v-8.666a3.667 3.667 0 0 1 3.667 -3.667zm-3.333 -4c1.094 0 1.828 .533 2.374 1.514a1 1 0 1 1 -1.748 .972c-.221 -.398 -.342 -.486 -.626 -.486h-10c-.548 0 -1 .452 -1 1v9.998c0 .32 .154 .618 .407 .805l.1 .065a1 1 0 1 1 -.99 1.738a3 3 0 0 1 -1.517 -2.606v-10c0 -1.652 1.348 -3 3 -3zm1.293 9.293l-3.293 3.292l-1.293 -1.292a1 1 0 0 0 -1.414 1.414l2 2a1 1 0 0 0 1.414 0l4 -4a1 1 0 0 0 -1.414 -1.414" />
                  </svg>
                </button>
                <button id="pinBtn" title="Pin">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#f703d7ff" class="bi bi-pin-angle-fill" viewBox="0 0 16 16">
                    <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a6 6 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707s.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a6 6 0 0 1 1.013.16l3.134-3.133a3 3 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146"/>
                  </svg>
                </button>
                <!--
                <button id="deleteBtn" title="Delete">
                  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-trash">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" />
                    <path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                    <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                  </svg>
                </button>
                -->
              </div>
              <!-- Sticky Date Header -->
              <div id="stickyDateHeader"></div>

              <!--<div id="scrollToBottomBtn" class="scroll-to-bottom" title="Scroll to bottom">‚¨áÔ∏è</div>-->
              <!-- Floating scroll-to-bottom -->
              <div id="scrollToBottomBtn" class="scroll-to-bottom hidden" title="Scroll to bottom">
                <svg  xmlns="http://www.w3.org/2000/svg"  width="48"  height="48"  viewBox="0 0 24 24"  fill="currentColor"  class="icon icon-tabler icons-tabler-filled icon-tabler-square-rounded-arrow-down">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 2c-.218 0 -.432 .002 -.642 .005l-.616 .017l-.299 .013l-.579 .034l-.553 .046c-4.785 .464 -6.732 2.411 -7.196 7.196l-.046 .553l-.034 .579c-.005 .098 -.01 .198 -.013 .299l-.017 .616l-.004 .318l-.001 .324c0 .218 .002 .432 .005 .642l.017 .616l.013 .299l.034 .579l.046 .553c.464 4.785 2.411 6.732 7.196 7.196l.553 .046l.579 .034c.098 .005 .198 .01 .299 .013l.616 .017l.642 .005l.642 -.005l.616 -.017l.299 -.013l.579 -.034l.553 -.046c4.785 -.464 6.732 -2.411 7.196 -7.196l.046 -.553l.034 -.579c.005 -.098 .01 -.198 .013 -.299l.017 -.616l.005 -.642l-.005 -.642l-.017 -.616l-.013 -.299l-.034 -.579l-.046 -.553c-.464 -4.785 -2.411 -6.732 -7.196 -7.196l-.553 -.046l-.579 -.034a28.058 28.058 0 0 0 -.299 -.013l-.616 -.017l-.318 -.004l-.324 -.001zm0 5a1 1 0 0 1 .993 .883l.007 .117v5.585l2.293 -2.292a1 1 0 0 1 1.32 -.083l.094 .083a1 1 0 0 1 .083 1.32l-.083 .094l-4 4a1.008 1.008 0 0 1 -.112 .097l-.11 .071l-.114 .054l-.105 .035l-.149 .03l-.117 .006l-.075 -.003l-.126 -.017l-.111 -.03l-.111 -.044l-.098 -.052l-.092 -.064l-.094 -.083l-4 -4a1 1 0 0 1 1.32 -1.497l.094 .083l2.293 2.292v-5.585a1 1 0 0 1 1 -1z" fill="currentColor" stroke-width="0" />
                </svg>
              </div>
            </div>

            <!-- Reply Preview -->
            <div id="replyPreview" class="d-none d-flex mt-0 mb-0 ms-4 me-4 reply-preview text-white p-2 rounded-2 justify-content-between align-items-center" 
                  style="border-left: 4px solid #018f14ff; background-color: #93db9d34; 
                        font-style: normal; box-shadow: 0 4px 8px #0000004d;">
              <span id="replyPreviewText"></span>
              <span id="cancelReply" class="avatar text-red p-0 border-0 d-flex align-items-center justify-content-center" style="cursor:pointer;">
                <!-- Cancel SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>

            {% if not request.user|has_group:"Demo" or request.user.is_superuser %} 
              <!-- Message Input --> 
              <div class="card-footer border-0"> 
                <div class="input-group input-group-flat rounded-2 border-0 d-flex align-items-end justify-content-center p-2" 
                      style="box-shadow: 0 4px 8px #000000d2; border-radius: 24px; background: #111827;"> 
                  <!-- Attachment container trigger --> 
                  <a href="#" class="link-secondary dropdown p-2 text-purple d-flex align-items-center justify-content-center" 
                              id="openUserGuestPopup"
                              style="flex: 0 0 auto;"> 
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-user-up"> 
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /> 
                      <path d="M6 21v-2a4 4 0 0 1 4 -4h4" /><path d="M19 22v-6" /><path d="M22 19l-3 -3l-3 3" /> 
                    </svg> 
                  </a> 
                  <textarea class="form-control border-0 flex-grow-1" id="chatInput" 
                            placeholder="Type Message" rows="1" 
                            style="resize: none; overflow: hidden; background: transparent;"></textarea> 
                  <!--<input type="text" class="form-control" autocomplete="on" placeholder="Type Message" id="chatInput">--> 
                  <!-- Send Button --> 
                  <a href="#" id="sendButton" class="link-secondary p-2 text-green d-flex align-items-center justify-content-center"
                      style="flex: 0 0 auto;"> 
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-send"> 
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/> <path d="M10 14l11 -11" />
                      <path d="M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5" /> 
                    </svg> 
                  </a> 
                  <!-- Mention dropdown -->
                  <div id="mentionDropdown" class="mention-dropdown d-none"></div>
                </div> 
              </div> 
            {% endif %}
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Central popup container -->
<div id="userGuestPopup" class="d-none">
  <div class="popup-backdrop"></div>
  <div class="popup-content">
    <div class="popup-header d-flex justify-content-between align-items-center">
      <input type="text" id="popupSearch" placeholder="Search Officers/Guests" class="form-control flex-grow-1 me-2">
      <span id="popupClose">
        <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M18 6l-12 12" /><path d="M6 6l12 12" />
        </svg>
      </span>
    </div>
    <div class="popup-body" id="popupBody"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/textarea-caret@3.1.0/index.min.js"></script>

<script>
const USERS = JSON.parse('{{ users_json|escapejs }}' || '[]');
const USER_GUESTS = JSON.parse('{{ user_guests_json|escapejs }}' || '[]');
const UNASSIGNED_GUESTS = JSON.parse('{{ unassigned_guests_json|escapejs }}' || '[]');
const LAST_MESSAGES = JSON.parse('{{ last_messages_json|escapejs }}' || '[]');
const CURRENT_USER_ID = {{ current_user_id }};
const CURRENT_USER_ROLE = "{{ current_user_role }}";

document.addEventListener("DOMContentLoaded", () => {
  const chatContainer = document.getElementById("chatMessagesContainer");
  const stickyDateHeader = document.getElementById("stickyDateHeader");
  const chatInput = document.getElementById("chatInput");
  const sendButton = document.getElementById("sendButton");
  const searchInput = document.getElementById("chatSearch");
  const replyPreview = document.getElementById("replyPreview");
  const replyPreviewText = document.getElementById("replyPreviewText");
  const cancelReply = document.getElementById("cancelReply");
  const openBtn = document.getElementById("openUserGuestPopup");
  const popup = document.getElementById("userGuestPopup");
  const popupBody = document.getElementById("popupBody");
  const popupSearch = document.getElementById("popupSearch");
  const closeBtn = document.getElementById("popupClose");
  const optionsPanel = document.getElementById("chatOptionsPanel");
  const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");
  const mentionDropdown = document.getElementById("mentionDropdown");
  //const roomId = chatContainer.dataset.roomId;

  let chatSocket = null;

  function connectSocket() {
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/`);

    chatSocket.onopen = () => {
      console.log("‚úÖ Connected to WebSocket");
    };

    chatSocket.onclose = (e) => {
      console.log("‚ùå Socket closed. Reconnecting in 3s...", e.reason);
      setTimeout(connectSocket, 3000); // üîÑ auto-reconnect
    };

    chatSocket.onerror = (err) => {
      console.error("Socket error:", err);
      chatSocket.close();
    };

    chatSocket.onmessage = (e) => {
      const data = JSON.parse(e.data);
      // Update your local USER_GUESTS
      if (data.guest && data.guest.assigned_user) {
          const idx = USER_GUESTS.findIndex(g => g.id === data.guest.id);
          if (idx !== -1) USER_GUESTS[idx].assigned_user = data.guest.assigned_user;
      }
      appendMessage(data); // üëà your existing handler
    };
  }

  // Call this once when the page loads
  connectSocket();

  function getUserColor(userId) {
    const colors = ["bg-blue-lt text-white","bg-green-lt text-white","bg-orange-lt text-white","bg-purple-lt text-white","bg-pink-lt text-white","bg-cyan-lt text-white","bg-yellow-lt text-white","bg-red-lt text-white","bg-indigo-lt text-white","bg-teal-lt text-white","bg-lime-lt text-white","bg-amber-lt text-white","bg-fuchsia-lt text-white","bg-emerald-lt text-white","bg-violet-lt text-white","bg-rose-lt text-white","bg-sky-lt text-white","bg-orange-200 text-white","bg-purple-200 text-white","bg-pink-200 text-white"];
    return colors[userId % colors.length];
  }

  let selectedGuest = null;
  let replyToId = null;
  let selectedBubbles = new Set(); // selected message IDs
  let lastSelectionClick = null;    // for detecting single-selection for edit/reply
  const isTouch = ("ontouchstart" in window);
  let loading = false;
  let oldestLoaded = null; // track oldest message timestamp
  const limit = 50;
  let lastMessageDate = null;

  // --- Input listener for "@" ---
  // Use users JSON from Django
  const usersList = USERS.map(u => ({
      id: u.id,
      full_name: u.full_name || u.username,
      title: u.title || "",
      username: u.username,
      image: u.image || null,
      color: (u.color && u.color.trim() !== "") ? u.color : "#00aeff71"
  }));

  let mentions = [];
  let filteredUsers = [];
  let currentSelection = 0;

  // --- Show dropdown above the input ---
  function showMentionDropdown() {
      if (!filteredUsers.length) return hideMentionDropdown();

      mentionDropdown.innerHTML = filteredUsers.map((u, idx) => `
          <div class="mention-item ${idx === currentSelection ? 'active' : ''}" data-id="${u.id}">
              <span class="avatar" style="${u.image ? 'background-image:url(' + u.image + ')' : ''}">
                  ${!u.image ? (u.full_name || u.username).slice(0,2).toUpperCase() : ''}
              </span>
              <div class="user-info d-flex">
                  <span class="title">${u.title || ''}</span>
                  <span class="name">${u.full_name}</span>
              </div>
          </div>
      `).join('');

      mentionDropdown.classList.remove("d-none");
      mentionDropdown.style.display = "block";

      // --- DROP-UP POSITIONING ---
      const parentRect = chatInput.offsetParent.getBoundingClientRect();
      const inputRect = chatInput.getBoundingClientRect();
      const dropdownHeight = mentionDropdown.offsetHeight;

      // Position above the input field
      mentionDropdown.style.left = (inputRect.left - parentRect.left) + "px";
      mentionDropdown.style.top = (inputRect.top - parentRect.top - dropdownHeight - 4) + "px"; // 4px gap
      mentionDropdown.style.minWidth = chatInput.offsetWidth + "px";
  }

  // --- Hide dropdown ---
  function hideMentionDropdown() {
      mentionDropdown.classList.add("d-none");
      mentionDropdown.style.display = "none";
      currentSelection = 0;
  }

  // --- Update highlighted item ---
  function updateActive() {
      const items = mentionDropdown.querySelectorAll("div");
      items.forEach((el, idx) => el.classList.toggle("active", idx === currentSelection));
  }

  // --- Select a mention ---
  function selectMention(item) {
      const userId = item.dataset.id;
      const user = filteredUsers.find(u => u.id == userId);
      if (!user) return;

      const cursorPos = chatInput.selectionStart;
      const textBefore = chatInput.value.slice(0, cursorPos);
      const textAfter = chatInput.value.slice(cursorPos);

      // Replace last @query with full mention
      const newText = textBefore.replace(/@([^\s@]*)$/, `@${user.title || ''} ${user.full_name}`) + textAfter;
      chatInput.value = newText;
      chatInput.focus();
      hideMentionDropdown();
  }

  // --- Input listener ---
  chatInput.addEventListener("input", () => {
      const cursorPos = chatInput.selectionStart;
      const textBeforeCursor = chatInput.value.slice(0, cursorPos);

      const match = textBeforeCursor.match(/@([^\s@]*)$/);
      if (match) {
          const query = match[1].toLowerCase();
          filteredUsers = USERS.filter(u => {
              const fullName = (u.full_name || u.username).toLowerCase();
              const title = (u.title || "").toLowerCase();
              return `${title} ${fullName}`.includes(query);
          });
          currentSelection = 0;
          showMentionDropdown();
      } else {
          hideMentionDropdown();
      }
  });

  // --- Keyboard navigation ---
  chatInput.addEventListener("keydown", (e) => {
      const items = mentionDropdown.querySelectorAll("div");
      if (!items.length) return;

      if (e.key === "ArrowDown") {
          e.preventDefault();
          currentSelection = (currentSelection + 1) % items.length;
          updateActive();
      } else if (e.key === "ArrowUp") {
          e.preventDefault();
          currentSelection = (currentSelection - 1 + items.length) % items.length;
          updateActive();
      } else if (e.key === "Enter" || e.key === "Tab") {
          if (currentSelection >= 0) {
              e.preventDefault();
              selectMention(items[currentSelection]);
          }
      } else if (e.key === "Escape") {
          hideMentionDropdown();
      }
  });

  // --- Click on mention ---
  mentionDropdown.addEventListener("click", (e) => {
      const item = e.target.closest("div[data-id]");
      if (item) selectMention(item);
  });

  // --- Expose mentions array for sendMessage ---
  //window.getCurrentMentions = () => mentions;
  //window.clearMentions = () => { mentions = []; };


  // Format timestamp to "Sept. 15, 2025 - 11:10"
  function formatForCopy(iso) {
    const d = new Date(iso);
    const months = ["Jan.","Feb.","Mar.","Apr.","May","Jun.","Jul.","Aug.","Sept.","Oct.","Nov.","Dec."];
    const datePart = `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
    const timePart = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
    return `${datePart} - ${timePart}`;
  }

  function updateOptionsPanelVisibility() {
    if (selectedBubbles.size > 0) {
      optionsPanel.classList.remove("hidden");
      optionsPanel.setAttribute("aria-hidden", "false");
    } else {
      optionsPanel.classList.add("hidden");
      optionsPanel.setAttribute("aria-hidden", "true");
    }
  }

  // Utility: gather selected bubble DOM nodes
  function getSelectedNodes() {
    return Array.from(selectedBubbles).map(id => document.getElementById(`chat-bubble-${id}`)).filter(Boolean);
  }

  // Toggle selection (highlight) for a single bubble
  function toggleBubbleSelection(bubbleEl, messageId) {
    if (selectedBubbles.has(messageId)) {
      selectedBubbles.delete(messageId);
      bubbleEl.classList.remove("selected");
    } else {
      selectedBubbles.add(messageId);
      bubbleEl.classList.add("selected");
    }
    updateOptionsPanelVisibility();
    // focus input on reply candidate (UX)
    chatInput.focus();
  }

  // Clear all selections
  function clearSelections() {
    getSelectedNodes().forEach(node => node.querySelector(".chat-bubble")?.classList.remove("selected"));
    selectedBubbles.clear();
    updateOptionsPanelVisibility();
  }

  // Guest Date of Visit Formatting
  function formatGuestDate(dateStr) {
    if (!dateStr) return "";
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateStr).toLocaleDateString(undefined, options);
  }

  // --- Safe Date Parser ---
  function safeParseDate(isoString) {
    if (!isoString) return null;
    // Strip microseconds like .123456
    const cleaned = isoString.replace(/\.\d+/, "");
    const d = new Date(cleaned);
    return isNaN(d.getTime()) ? null : d;
  }

  // --- Update getDateText to use safe date ---
  function getDateText(date) {
    if (!date) return "";
    const now = new Date();
    const msgDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);

    if (msgDay.getTime() === today.getTime()) return "Today";
    if (msgDay.getTime() === yesterday.getTime()) return "Yesterday";

    const diffTime = today.getTime() - msgDay.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    if (diffDays < 7) return msgDay.toLocaleDateString(undefined, { weekday: "long" });

    return msgDay.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
  }

  // Attach from Guest list to Chat handler
  document.querySelectorAll(".attach-to-chat").forEach(item => {
    item.addEventListener("click", (e) => {
      e.preventDefault();
      
      let guest = JSON.parse(e.currentTarget.getAttribute("data-guest"));

      // üîπ ALWAYS populate assigned_user from your arrays
      const matchedGuest =
        USER_GUESTS.find(g => g.id === guest.id) ||
        UNASSIGNED_GUESTS.find(g => g.id === guest.id);

      guest.assigned_user = matchedGuest?.assigned_user || null;

      createGuestPreview(guest);
      chatInput.focus();
      chatInput.scrollIntoView({ behavior: "smooth", block: "center" });
    });
  });

  // Reply preview HTML (used for both reply bar + inside bubbles)
  function createReplyPreviewHTML(data, inBubble = false) {
    let replyOwner = "";

    if (data.parent) {
      if (data.parent.sender_id === CURRENT_USER_ID) {
        replyOwner = "You";
      } else {
        replyOwner = `${data.parent.sender_title} ${data.parent.sender_name}`;
      }
    }

    const innerHTML = data.parent
      ? `
        <small style="color: inherit;">${replyOwner}</small><br>
        <span class="text-secondary">
          ${data.parent.message.length > 50
            ? data.parent.message.substring(0, 50) + "..."
            : data.parent.message}
        </span>
        ${
          data.parent.guest
            ? `<div class="d-flex align-items-center mt-1">
                ${
                  data.parent.guest.image
                    ? `<img src="${data.parent.guest.image}"
                            style="width:35px;height:35px;border-radius:4px;object-fit:cover;" />`
                    : `<span class="avatar bg-gray d-flex align-items-center justify-content-center"
                            style="width:35px;height:35px;border-radius:4px;">
                        ${data.parent.guest.name[0]}
                      </span>`
                }
                <span class="ms-2 text-warning">
                  ${data.parent.guest.title} ${data.parent.guest.name}
                </span>
              </div>`
            : ""
        }
      `
      : "";

    // Wrap in container only if it's for a bubble
    return inBubble
      ? `<div class="chat-reply-preview fs-7 mb-1 p-1 rounded"
                data-parent-id="${data.parent.id}"
                style="cursor:pointer; background:#1f2937;
                      border-left:4px solid #018f14ff; width:auto;
                      box-shadow: 0 4px 8px #0000004d;">
            ${innerHTML}
        </div>`
      : innerHTML;
  }


  // Render Message
  function renderMessage(data, isPrepend = false) {
    //console.log("Incoming message:", data);
    const isMe = data.sender_id === CURRENT_USER_ID;

    const replyHTML = data.parent ? createReplyPreviewHTML({ parent: data.parent }, true) : "";

    const bubbleColorClass = isMe ? "bg-green-lt text-white" : data.color;

    const bubble = document.createElement("div");
    bubble.dataset.createdAt = data.created_at;
    bubble.classList.add("chat-item");
    bubble.id = `chat-bubble-${data.id}`;
    //bubble.dataset.senderId = data.sender_id;   // üî• needed for edit check
    bubble.dataset.color = data.color || "";   // helpful for reply handler
    //bubble.dataset.edited = data.edited ? "true" : "false"; // if already edited

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // Escape special regex chars
    }

    function renderMessageWithMentions(message, mentionsList) {
      if (!mentionsList || !mentionsList.length) return message;

      let renderedMsg = message;

      mentionsList.forEach(m => {
        const titlePrefix = m.title ? m.title + ' ' : '';
        const name = m.name || m.fullname; // fallback

        const regex = new RegExp(`@${escapeRegex(titlePrefix + name)}`, 'gi');

        // Use the user's color (fall back to default if undefined)
        const mentionColor = m.color || "#00aeffff";

        renderedMsg = renderedMsg.replace(
          regex,
          `<span class="mention" style="color:${mentionColor}">@${titlePrefix}${name}</span>`
        );
      });

      return renderedMsg;
    }

    let guestHTML = "";
    if (data.guest) {
      bubble.dataset.guest = JSON.stringify(data.guest);
      const formattedGuestDate = formatGuestDate(data.guest.date_of_visit);

      // Check if guest has an assigned user
      const assignedUser = data.guest.assigned_user; // make sure your guest object includes assigned user
      if (assignedUser) {
        console.log("Assigned:", assignedUser.full_name);
      } else {
        console.log("No assigned user");
      }
      let assignedHTML = "";
      if (assignedUser) {
        assignedHTML = `
          <div class="assigned-user d-flex align-items-center gap-2">
            <div class="avatar rounded"
                style="width:32px; height:32px; background-color: #11182781; overflow:hidden; 
                        display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 8px #000000a1;"">
              ${assignedUser.image
                  ? `<img src="${assignedUser.image}" alt="${assignedUser.full_name}" style="width:100%; height:100%; object-fit:cover;">`
                  : `${assignedUser.full_name ? assignedUser.full_name[0].toUpperCase() : "?"}`}
            </div>
            <span class="text-white small">${assignedUser.title || ''} ${assignedUser.full_name}</span>
          </div>
        `;
      }

      guestHTML = `
        <div class="chat-guest-card text-white px-2 py-2 mb-2 rounded-2 d-flex flex-column align-items-center gap-2"
            style="box-shadow: 0 4px 8px #000000a1; background-color: #11182781;">
          ${data.guest.image
              ? `<img src="${data.guest.image}" alt="${data.guest.name}" 
                      style="width:200px; height:200px; object-fit:cover; border-radius:6px;
                      box-shadow: 0 4px 8px #000000a1;">`
              : `<div class="avatar bg-gray d-flex align-items-center justify-content-center fs-2 fw-bold"
                    style="width:200px; height:200px; border-radius:6px;
                    box-shadow: 0 4px 8px #000000a1;">
                  ${data.guest.name ? data.guest.name[0].toUpperCase() : "?"}
                </div>`}
          <div class="text-center mt-2">
            <div class="fw-bold fs-3 text-warning">${data.guest.title} ${data.guest.name}</div>
            <div class="text-muted">${data.guest.custom_id}</div>
            <div>${formattedGuestDate}</div>
          </div>
          ${assignedHTML}
        </div>
      `;
    }

    const avatarHTML = data.sender_image
      ? `<span class="avatar rounded" style="background-image:url('${data.sender_image}'); width:40px; height:40px; background-size:cover; background-position:center;"></span>`
      : `<span class="avatar ${data.color} d-flex align-items-center justify-content-center rounded"
              style="width:40px; height:40px; font-weight:bold;">
          ${data.sender_name.split(' ').map(n => n[0])[0] || data.sender_name[0]}
        </span>`;

    const messageHTML = renderMessageWithMentions(data.message, data.mentions);
    bubble.innerHTML = `
      <div class="d-flex align-items-end ${isMe ? "justify-content-end" : ""}">
        ${!isMe ? `<div class="me-2">${avatarHTML}</div>` : ""}
        <div class="chat-bubble mb-4 ${isMe ? 'chat-bubble-me' : ""} ${bubbleColorClass}"
            style="box-shadow: 0 4px 8px #0000004d; display: flex; flex-direction: column;
                    align-items: stretch; cursor: pointer; max-width: 75%; border-radius: 12px; width: fit-content;">
          ${!isMe ? `
            <div class="chat-bubble-title" style="font-size: 0.75rem;">
              <small><i class="chat-bubble-author" style="color: inherit;">
                ${data.sender_title} ${data.sender_name}
              </i></small>
            </div>` : ""}
          <div class="chat-bubble-body" style="display: block; gap: 0.5rem; padding: 0;">
            ${replyHTML}
            ${guestHTML}

            <div class="message-row" style="display: block; margin: 0;">
              <div class="fs-4 text-white"
                  style="white-space: pre-wrap; word-break: break-word; margin:0; padding:0;">${messageHTML}</div>
              <div style="display:flex; justify-content:flex-end; width:100%;">
                <small class="chat-bubble-date text-muted"
                      style="white-space: nowrap; font-size: 0.6rem;" 
                      data-full-date="${data.created_at}">
                  ${new Date(data.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
                </small>
              </div>
            </div>
          <div class="chat-bubble-flags"></div>
        </div>
      </div>
    `;

    //üìå Add flags if pinned/mentioned
    const flags = bubble.querySelector(".chat-bubble-flags");
      if (data.pinned) {
        const pin = document.createElement("span");
        pin.classList.add("pin-flag");
        pin.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pin-angle-fill" viewBox="0 0 16 16">
            <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a6 6 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707s.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a6 6 0 0 1 1.013.16l3.134-3.133a3 3 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146"/>
          </svg>`;
        flags.appendChild(pin);
      }
      if (data.mentions && data.mentions.some(m => parseInt(m.id) === CURRENT_USER_ID)) {
        const flag = document.createElement("span");
        flag.classList.add("mention-flag");
        flag.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" 
              fill="none" stroke="currentColor" stroke-width="2" 
              stroke-linecap="round" stroke-linejoin="round" 
              class="icon icon-tabler icons-tabler-outline icon-tabler-at bounce-flag">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
            <path d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28" />
          </svg>`;
        flags.appendChild(flag);
      }

    // Set message text and preserve newlines
    //const msgDiv = bubble.querySelector(".fs-3");
    //msgDiv.style.whiteSpace = "pre-wrap"; // preserves \n
    //msgDiv.textContent = data.message;

    // üî• Update last message preview in user list (left column)
    const lastMsgEl = document.getElementById(`last-message-${data.sender_id}`);
    if (lastMsgEl) {
      let preview = data.message && data.message.trim() ? data.message : "(Attachment)";
      if (preview.length > 28) preview = preview.slice(0, 28) + "‚Ä¶";
      lastMsgEl.textContent = preview;
    }


    // ---------- selection handlers ----------
    const chatBubbleEl = bubble.querySelector(".chat-bubble");

    // Desktop: right-click opens selection/option panel
    if (!isTouch) {
      chatBubbleEl.addEventListener("contextmenu", (ev) => {
        ev.preventDefault();
        toggleBubbleSelection(chatBubbleEl, data.id);
      });
      // left-click toggles selection if options are open (so user can multi-select easily)
      chatBubbleEl.addEventListener("click", (ev) => {
        if (selectedBubbles.size > 0) {
          ev.preventDefault();
          toggleBubbleSelection(chatBubbleEl, data.id);
        }
      });
    }

    // Mobile: long-press opens selection/option panel (500ms)
    if (isTouch) {
      let pressTimer;
      chatBubbleEl.addEventListener("touchstart", (ev) => {
        pressTimer = setTimeout(() => toggleBubbleSelection(chatBubbleEl, data.id), 500);
      });
      ["touchend","touchmove","touchcancel"].forEach(e => chatBubbleEl.addEventListener(e, ()=> clearTimeout(pressTimer)));
      // swipe to reply (left/right) - preserved
      let touchStartX = 0, touchEndX = 0;
      chatBubbleEl.addEventListener("touchstart", (e)=> touchStartX = e.changedTouches[0].screenX);
      chatBubbleEl.addEventListener("touchend", (e)=> {
        touchEndX = e.changedTouches[0].screenX;
        if (Math.abs(touchEndX - touchStartX) > 50) {
          // trigger reply preview for single bubble
          replyToId = data.id;
          replyPreview.classList.remove("d-none");
          replyPreviewText.innerHTML = `<small class="text-secondary">${data.sender_title} ${data.sender_name}</small><br> ${data.message}`;

          if (data.guest) {
            replyPreviewText.innerHTML += `
              <div class="d-flex align-items-center mt-1">
                ${
                  data.guest.image
                    ? `<img src="${data.guest.image}" style="width:35px;height:35px;border-radius:4px;object-fit:cover;" />`
                    : `<span class="avatar bg-gray d-flex align-items-center justify-content-center" 
                          style="width:35px;height:35px;border-radius:4px;">${data.guest.name[0]}</span>`
                }
                <span class="ms-2 text-warning">${data.guest.title} ${data.guest.name}</span>
              </div>`;
          }
          chatInput.focus();
        }
      });
    }

    // ========== Click reply preview inside bubble -> scroll & highlight ==========
    bubble.querySelectorAll(".chat-reply-preview").forEach(el => {
      el.addEventListener("click", () => {
        const parentEl = document.getElementById(`chat-bubble-${el.dataset.parentId}`);
        if (parentEl) {
          parentEl.scrollIntoView({ behavior: "smooth", block: "center" });
          
          // ‚úÖ apply highlight directly to bubble div
          const bubbleEl = parentEl.querySelector(".chat-bubble");
          if (bubbleEl) {
            bubbleEl.classList.add("highlight-chat-bubble");
            setTimeout(() => bubbleEl.classList.remove("highlight-chat-bubble"), 2000);
          }
        }
      });
    });

    if (cancelReply) {
      cancelReply.addEventListener("click", () => {
        replyToId = null;
        replyPreview.classList.add("d-none");
        replyPreviewText.innerHTML = ""; // clear text
      });
    }
    return bubble;
  }

  // ---------- Prepend older messages ----------
  function prependMessages(messages) {
    const prevScrollHeight = chatContainer.scrollHeight;
    const prevScrollTop = chatContainer.scrollTop;

    // ‚úÖ Keep backend order (oldest ‚Üí newest)
    messages.forEach(msg => {
      if (!document.getElementById(`chat-bubble-${msg.id}`)) {
        chatContainer.prepend(renderMessage(msg, true));
      } else {
        console.warn("Duplicate skipped (prepend):", msg.id);
      }
    });

    // ‚úÖ Restore scroll position after prepend
    chatContainer.scrollTop = chatContainer.scrollHeight - prevScrollHeight + prevScrollTop;

    // ‚úÖ Rebuild separators cleanly
    normalizeDateSeparators();
    updateStickyHeader();
  }

  // ---------- Normalize date separators ----------
  // --- normalizeDateSeparators (fixed to use safeParseDate) ---
  function normalizeDateSeparators() {
    chatContainer.querySelectorAll(".chat-date-separator").forEach(el => el.remove());

    let lastDay = null;
    const messages = [...chatContainer.querySelectorAll(".chat-item")]
      .sort((a, b) => {
        const da = safeParseDate(a.dataset.createdAt);
        const db = safeParseDate(b.dataset.createdAt);
        return da - db;
      });

    // ‚úÖ Clear container and rebuild in order
    messages.forEach(msg => chatContainer.appendChild(msg));

    messages.forEach(msg => {
      const createdAt = msg.dataset.createdAt;
      if (!createdAt) return;
      const msgDateObj = safeParseDate(createdAt);
      if (!msgDateObj) return;

      const msgDay = new Date(msgDateObj.getFullYear(), msgDateObj.getMonth(), msgDateObj.getDate());

      if (!lastDay || msgDay.getTime() !== lastDay.getTime()) {
        lastDay = msgDay;

        const separator = document.createElement("div");
        separator.classList.add("chat-date-separator", "mb-2");
        Object.assign(separator.style, {
          display: "inline-block",
          padding: "2px 12px",
          borderRadius: "20px",
          fontWeight: "500",
          fontSize: "0.8rem",
          color: "#f59f00",
          backgroundColor: "#343531",
          boxShadow: "0 4px 8px rgba(0,0,0,0.4)",
          textAlign: "center",
          margin: "0 auto"
        });
        separator.textContent = getDateText(msgDay);

        chatContainer.insertBefore(separator, msg);
      }
    });
  }

  function updateStickyHeader() {
    const separators = Array.from(chatContainer.querySelectorAll(".chat-date-separator"));
    let headerText = "";
    const containerRect = chatContainer.getBoundingClientRect();

    for (let i = 0; i < separators.length; i++) {
      const sep = separators[i];
      const rect = sep.getBoundingClientRect();

      if (rect.top <= containerRect.top + 10) {
        headerText = sep.textContent;
      }
    }

    if (headerText) {
      stickyDateHeader.textContent = headerText;
      stickyDateHeader.style.opacity = "1";
      stickyDateHeader.style.transform = "translate(-50%, 0)";
    } else {
      stickyDateHeader.style.opacity = "0";
    }
  }
  chatContainer.addEventListener("scroll", updateStickyHeader);


  // ---------- Load more ----------
  async function loadMoreMessages() {
    if (loading) return;
    loading = true;
    let url = `load/?limit=${limit}`;
    if (oldestLoaded) url += `&before=${encodeURIComponent(oldestLoaded)}`;

    try {
      const res = await fetch(url);
      const data = await res.json();

      if (data.messages.length) {
        prependMessages(data.messages);

        // ‚úÖ first element is now the oldest
        oldestLoaded = data.messages[0].created_at;
      }
    } catch (err) {
      console.error(err);
    }

    loading = false;
  }

  // ---------- Append new live message ----------
  function appendMessage(data) {
    // üîπ Ensure assigned_user is included for rendering immediately
    if (data.guest) {
      const latestGuest = USER_GUESTS.find(g => g.id === data.guest.id) || UNASSIGNED_GUESTS.find(g => g.id === data.guest.id);
      data.guest.assigned_user = latestGuest?.assigned_user || data.guest.assigned_user || null;
    }

    if (document.getElementById(`chat-bubble-${data.id}`)) return console.warn("Duplicate skipped (append):", data.id);

    const bubble = renderMessage(data);
    chatContainer.appendChild(bubble);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    normalizeDateSeparators();
    updateStickyHeader();
  }

  // ---------- Infinite scroll ----------
  chatContainer.addEventListener("scroll", () => {
    if (chatContainer.scrollTop === 0 && !loading) loadMoreMessages();
  });

  // ---------- Initial load ----------
  loadMoreMessages();


  LAST_MESSAGES.forEach(appendMessage);

  function detectMentionsFromText(text) {
    const detected = [];
    usersList.forEach(u => {
      const regex = new RegExp(`@(${u.title ? u.title + '\\s' : ''})?${u.full_name}`, 'i');
      if (regex.test(text) && !mentions.some(m => m.id == u.id)) {
        detected.push({ id: u.id, title: u.title, name: u.full_name });
      }
    });
    return detected;
  }

  function sendMessage(message = "", guest = selectedGuest) {
    console.log("üîπ sendMessage triggered", { message, guest, replyToId, chatSocket });

    if (!message.trim() && !guest && !replyToId) {
      console.warn("sendMessage exited: empty message, no guest, no reply");
      return;
    }

    if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
      console.warn("sendMessage exited: WebSocket not open", chatSocket?.readyState);
      return;
    }

    // üîπ Ensure assigned_user is included
    if (guest) {
      // Use already assigned user if present
      if (!guest.assigned_user) {
        const latestGuest = USER_GUESTS.find(g => g.id === guest.id) || UNASSIGNED_GUESTS.find(g => g.id === guest.id);
        guest.assigned_user = latestGuest?.assigned_user || null;
      }
    }

    // Detect manually typed mentions
    const manualMentions = detectMentionsFromText(message).map(m => {
      const user = USERS.find(u => u.id === m.id); // get the full user object
      return {
        ...m,
        color: user?.color || "#00aeffff" // assign their chat bubble color
      };
    });

    // Push to mentions array
    manualMentions.forEach(m => mentions.push(m));

    // Edit mode
    //if (chatInput.dataset.editingId) {
    //  const editId = parseInt(chatInput.dataset.editingId, 10);
    //  const node = document.getElementById(`chat-bubble-${editId}`);
    //  if (node) {
    //    node.dataset.edited = "true";
    //    const body = node.querySelector(".chat-bubble-body .fs-4");
    //    if (body) body.textContent = message.trim();

    //    let editedTag = node.querySelector(".edited-flag");
    //    if (!editedTag) {
    //      const dateEl = node.querySelector(".chat-bubble-date");
    //      if (dateEl) {
    //        editedTag = document.createElement("span");
    //        editedTag.className = "edited-flag text-muted ms-1";
    //        editedTag.style.fontSize = "0.7rem";
    //        editedTag.textContent = "(Edited)";
    //        dateEl.appendChild(editedTag);
    //      }
    //    }
    //  }

    //  chatSocket.send(JSON.stringify({
    //    action: "edit",
    //    message_id: editId,
    //    new_text: message.trim(),
    //    sender_id: CURRENT_USER_ID
    //  }));

    //  chatInput.value = "";
    //  delete chatInput.dataset.editingId;
    //  return;
    //}

    const payload = {
      message: message.trim(),
      sender_id: CURRENT_USER_ID,
      guest_id: guest ? parseInt(guest.id, 10) : null,
      reply_to_id: replyToId || null,
      mentions: mentions.map(m => m.id),
      guest: guest
      ? {
          id: parseInt(guest.id, 10),
          name: guest.name,
          custom_id: guest.custom_id,
          image: guest.image,
          title: guest.title,
          date_of_visit: guest.date_of_visit,
          assigned_user: guest.assigned_user || null
        }
      : null
    };

    // üî• Log guest info reliably
    console.group("üìù Sending message");
    console.log("Guest object:", guest);
    console.log("Assigned user:", guest?.assigned_user);
    console.log("Message content:", message.trim());
    console.groupEnd();

    if (guest) {
      payload.guest = {
        id: parseInt(guest.id, 10),
        name: guest.name,
        custom_id: guest.custom_id,
        image: guest.image,
        title: guest.title,
        date_of_visit: guest.date_of_visit,
        //assigned_user: guest.assigned_user || null
      };
    }

    chatSocket.send(JSON.stringify(payload));

    // Cleanup
    chatInput.value = "";
    removeGuestPreview();
    replyToId = null;
    replyPreview.classList.add("d-none");
    //window.clearMentions();
    mentions = [];
  }

  // escape HTML to prevent injection when using textContent-like replacement in innerHTML
  function escapeHtml(unsafe) {
    if (unsafe == null) return "";
    return String(unsafe)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // ---------- Options actions (frontend + WS emits) ----------
  // Get current user's full name from USERS array
  const currentUser = USERS.find(u => u.id === CURRENT_USER_ID);
  const CURRENT_USER_NAME = currentUser ? currentUser.full_name : "Unknown";

  // When copying messages
  document.getElementById("copyBtn").addEventListener("click", async () => {
    if (!selectedBubbles.size) return;

    const parts = [];

    for (const id of selectedBubbles) {
        const node = document.getElementById(`chat-bubble-${id}`);
        if (!node) continue;

        const text = node.querySelector(".chat-bubble-body .fs-4")?.textContent || "";
        const iso = node.querySelector(".chat-bubble-date")?.dataset?.fullDate || new Date().toISOString();

        const ownerId = parseInt(node.dataset.senderId, 10);
        const owner = ownerId === CURRENT_USER_ID
            ? CURRENT_USER_NAME   // <-- full name of current user
            : node.querySelector(".chat-bubble-author")?.textContent || "Unknown";

        parts.push(`${formatForCopy(iso)} ‚Äî ${owner}:\n${text}\n`);
    }

    const final = parts.join("\n");
    await navigator.clipboard.writeText(final);

    // show SVG checkmark for feedback
    const btn = document.getElementById("copyBtn");
    btn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="green" viewBox="0 0 16 16">
      <path d="M13.485 1.929a.5.5 0 0 1 .07.707l-7 8a.5.5 0 0 1-.714.03l-3-3a.5.5 0 0 1 .708-.708L6 9.293l6.778-7.778a.5.5 0 0 1 .707-.07z"/>
    </svg>`;
    
    setTimeout(() => {
      // restore original copy SVG
      btn.innerHTML = `
      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="#02bd12ff"  class="icon icon-tabler icons-tabler-filled icon-tabler-copy-check">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M18.333 6a3.667 3.667 0 0 1 3.667 3.667v8.666a3.667 3.667 0 0 1 -3.667 3.667h-8.666a3.667 3.667 0 0 1 -3.667 -3.667v-8.666a3.667 3.667 0 0 1 3.667 -3.667zm-3.333 -4c1.094 0 1.828 .533 2.374 1.514a1 1 0 1 1 -1.748 .972c-.221 -.398 -.342 -.486 -.626 -.486h-10c-.548 0 -1 .452 -1 1v9.998c0 .32 .154 .618 .407 .805l.1 .065a1 1 0 1 1 -.99 1.738a3 3 0 0 1 -1.517 -2.606v-10c0 -1.652 1.348 -3 3 -3zm1.293 9.293l-3.293 3.292l-1.293 -1.292a1 1 0 0 0 -1.414 1.414l2 2a1 1 0 0 0 1.414 0l4 -4a1 1 0 0 0 -1.414 -1.414" />
      </svg>`;
    }, 900);

    clearSelections();
  });


  document.getElementById("pinBtn").addEventListener("click", () => {
    if (!selectedBubbles.size) return;

    const ids = Array.from(selectedBubbles);

    ids.forEach(id => {
      const node = document.getElementById(`chat-bubble-${id}`);
      if (!node) return;

      const bubble = node.querySelector(".chat-bubble");
      const flags = bubble.querySelector(".chat-bubble-flags");

      if (node.dataset.pinned === "true") {
        // remove pin
        const el = flags.querySelector(".pin-flag");
        if (el) el.remove();
        node.dataset.pinned = "false";
      } else {
        // add pin
        const s = document.createElement("span");
        s.className = "pin-flag";
        s.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pin-angle-fill" viewBox="0 0 16 16">
            <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a6 6 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707s.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a6 6 0 0 1 1.013.16l3.134-3.133a3 3 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146"/>
          </svg>`;
        flags && flags.prepend(s);
        node.dataset.pinned = "true";
      }
    });

    // persist pin state via WebSocket
    chatSocket.send(JSON.stringify({
      action: "pin",
      message_ids: ids,
      sender_id: CURRENT_USER_ID
    }));

    // flash pin button for feedback
    const btn = document.getElementById("pinBtn");
    btn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="gold" viewBox="0 0 16 16">
        <path d="M4 1.5a.5.5 0 0 1 .5.5v7.793l2.146-2.147a.5.5 0 0 1 .708.708L5.207 10.207H12.5a.5.5 0 0 1 0 1H5.207l2.147 2.146a.5.5 0 0 1-.708.708L4.5 11.207V19.5a.5.5 0 0 1-1 0V2a.5.5 0 0 1 .5-.5z"/>
      </svg>
    `;

    setTimeout(() => {
      // restore original SVG
      btn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#f703d7ff" class="bi bi-pin-angle-fill" viewBox="0 0 16 16">
          <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a6 6 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707s.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a6 6 0 0 1 1.013.16l3.134-3.133a3 3 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146"/>
        </svg>
      `;
    }, 900);

    clearSelections();
  });


  // === REPLY BUTTON HANDLER ===
  document.getElementById("replyBtn").addEventListener("click", () => {
    if (selectedBubbles.size === 0) return;

    // pick the last selected bubble
    const id = Array.from(selectedBubbles).pop();
    const node = document.getElementById(`chat-bubble-${id}`);
    if (!node) return;

    // grab the same data structure already stored on the bubble
    const messageData = {
      id,
      sender_id: parseInt(node.dataset.senderId, 10),
      sender_title: node.querySelector(".chat-bubble-author")?.textContent.split(" ")[0] || "",
      sender_name: node.querySelector(".chat-bubble-author")?.textContent.split(" ").slice(1).join(" ") || "",
      color: node.dataset.color || "text-primary",
      message: node.querySelector(".chat-bubble-body .fs-4")?.textContent || "",
      guest: node.dataset.guest ? JSON.parse(node.dataset.guest) : null,
    };

    // ‚úÖ use exactly the same reply preview HTML as swipe-to-reply
    replyToId = id;
    replyPreview.classList.remove("d-none");
    replyPreviewText.innerHTML = createReplyPreviewHTML({ parent: messageData });

    chatInput.focus();
    clearSelections();
  });

  // Clicking outside panel clears selection
  document.addEventListener("click", (e) => {
    if (!optionsPanel.contains(e.target) && !e.target.closest(".chat-bubble")) {
      clearSelections();
    }
  });

  // scroll-to-bottom behavior
  function updateScrollButton() {
    const atBottom = (chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight) < 60;
    if (!atBottom) scrollToBottomBtn.classList.add("show"); else scrollToBottomBtn.classList.remove("show");
  }
  chatContainer.addEventListener("scroll", updateScrollButton);
  scrollToBottomBtn.addEventListener("click", ()=> chatContainer.scrollTo({top: chatContainer.scrollHeight, behavior:"smooth"}));

  function createGuestPreview(guest){
    // ensure assigned_user is always present
    const matchedGuest =
        USER_GUESTS.find(g => g.id === guest.id) ||
        UNASSIGNED_GUESTS.find(g => g.id === guest.id);
    guest.assigned_user = matchedGuest?.assigned_user || null;
    removeGuestPreview();
    selectedGuest = guest;

    const preview = document.createElement("div");
    preview.id = "guestPreview";
    preview.classList.add("d-flex","align-items-center","text-white","border-0","p-2","mb-2","rounded-2","bg-gray-900");
    preview.innerHTML = `
      ${guest.image
        ? `<img src="${guest.image}" style="width:70px;height:70px;border-radius:4px;object-fit:cover;margin-right:10px;">`
        : `<span class="avatar bg-gray d-flex align-items-center justify-content-center"
                  style="width:70px;height:70px;border-radius:4px;margin-right:10px;">${guest.name[0]}</span>`}

      <div class="flex-grow-1">
        <strong class="text-warning">${guest.title} ${guest.name}</strong><br> (${guest.custom_id})<br>
        ${guest.date_of_visit}
      </div>
      <span id="cancelGuestPreview" class="avatar text-red p-0 border-0 d-flex align-items-center justify-content-center" style="width:24px; height:24px; cursor:pointer;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
        </svg>
      </span>
    `;
    chatInput.parentElement.parentElement.insertBefore(preview, chatInput.parentElement);

    document.getElementById("cancelGuestPreview").addEventListener("click", removeGuestPreview);
    chatInput.focus();
  }

  function removeGuestPreview(){
    const preview = document.getElementById("guestPreview");
    if(preview) preview.remove();
    selectedGuest = null;
  }

  chatInput.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(chatInput.value); });
  sendButton.addEventListener("click", e => { e.preventDefault(); sendMessage(chatInput.value); });

  chatSocket.onmessage = e => appendMessage(JSON.parse(e.data));

  // ==========================
  // Central User/Guest Popup
  // ==========================
  openBtn.addEventListener("click", () => { popup.classList.remove("d-none"); renderList(""); });
  closeBtn.addEventListener("click", () => popup.classList.add("d-none"));
  popup.querySelector(".popup-backdrop").addEventListener("click", () => popup.classList.add("d-none"));
  popupSearch.addEventListener("input", e => renderList(e.target.value));

  function renderList(filter) {
    popupBody.innerHTML = "";

    const userGuestsMap = {};
    USER_GUESTS.forEach(u => userGuestsMap[u.id] = u.guests || []);

    let visibleUsers = [];

    if (CURRENT_USER_ROLE === "Superuser") {
      visibleUsers = USERS;  // Superuser sees all
    } else if (["Pastor","Team Lead","Admin"].includes(CURRENT_USER_ROLE)) {
      visibleUsers = USERS.filter(u => u.role !== "Superuser");  // others see all except superusers
    } else {
      visibleUsers = USERS.filter(u => u.id === CURRENT_USER_ID); // regular users only see self
    }

    //console.log("Current Role:", CURRENT_USER_ROLE);
    //console.log("Visible Users:", visibleUsers.map(u => `${u.full_name} (${u.role})`));

    visibleUsers.forEach(user => {
      const assignedGuests = userGuestsMap[user.id] || [];
      let allGuests = [...assignedGuests];

      // Add unassigned guests only under *self* if privileged
      if (
        user.id === CURRENT_USER_ID &&
        ["Pastor","Team Lead","Admin","Superuser"].includes(CURRENT_USER_ROLE)
      ) {
        allGuests = allGuests.concat(UNASSIGNED_GUESTS);
      }

      const userMatches = user.full_name.toLowerCase().includes(filter.toLowerCase());
      const filteredGuests = allGuests.filter(g =>
        g.name.toLowerCase().includes(filter.toLowerCase())
      );

      const userColorClass = getUserColor(user.id);

      if (userMatches || filteredGuests.length > 0) {
        const userDiv = document.createElement("div");
        userDiv.classList.add("user-item");
        userDiv.innerHTML = `
          <div class="d-flex align-items-center gap-2 p-2">
            ${user.image
              ? `<img src="${user.image}" alt="${user.full_name}" 
                      style="width:32px; height:32px; object-fit:cover; border-radius:6px;">`
              : `<div class="avatar ${userColorClass} bg-gray d-flex align-items-center justify-content-center fs-2 fw-bold"
                    style="width:32px; height:32px; border-radius:6px;">
                  ${user.full_name ? user.full_name[0].toUpperCase() : "?"}
                </div>`}           
            <strong class="flex-grow-1 ${userColorClass} p-1 rounded">
              ${user.title ? user.title + " " : ""} ${user.full_name}
            </strong>
          </div>
        `;
        popupBody.appendChild(userDiv);

        const guestContainer = document.createElement("div");
        guestContainer.classList.add("guest-list");
        guestContainer.style.display = "none";

        // After creating guestContainer
        if (filteredGuests.length > 0) {
          filteredGuests.forEach(g => {
            const guestItem = document.createElement("div");
            guestItem.classList.add("guest-item");

            const avatar = g.image 
              ? `<img src="${g.image}" class="guest-avatar" style="width:50px;height:50px;border-radius:4px;object-fit:cover;margin-right:10px;">`
              : `<div class="guest-avatar bg-gray-900 d-flex align-items-center justify-content-center" style="width:50px;height:50px;border-radius:4px;font-size:12px;font-weight:bold;color:white;">
                  ${g.name.split(" ").map(n => n[0]).join('')}
                </div>`;

            const badge = g.assigned
              ? '<span class="badge-assigned bg-green-lt text-white">Assigned</span>'
              : '<span class="badge-unassigned bg-red-lt text-white">Unassigned</span>';

            guestItem.innerHTML = `<div class="col-12 me-3 mb-2">
                                    <div class="card shadow-sm border-0">
                                      <div class="card-body py-2 px-3 d-flex align-items-center">
                                        <div class="me-3">${avatar}</div>
                                        <div class="flex-grow-1">
                                          <span>${g.title ? g.title+" " : ""}${g.name}</span>
                                          ${badge}
                                        </div>
                                      </div>
                                    </div>
                                  </div>`;
            guestItem.addEventListener("click", () => {
              createGuestPreview(g);
              popup.classList.add("d-none");
            });
            guestContainer.appendChild(guestItem);
          });
        } else {
          // Show "No Guests Assigned Yet"
          const emptyMsg = document.createElement("div");
          emptyMsg.classList.add("text-muted", "px-3", "py-2", "fst-italic");
          emptyMsg.innerText = "No Guests Assigned Yet";
          guestContainer.appendChild(emptyMsg);
        }

        popupBody.appendChild(guestContainer);

        userDiv.addEventListener("click", () => {
          guestContainer.style.display = guestContainer.style.display === "none" ? "block" : "none";
        });
      }
    });
  }

  //Chat Live Search
  searchInput.addEventListener("input", function () {
    const query = this.value.toLowerCase().trim();
    const chatItems = chatContainer.querySelectorAll(".chat-item");

    chatItems.forEach(item => {
      const text = item.innerText.toLowerCase();
      if (text.includes(query)) {
        item.style.display = "";   // show
      } else {
        item.style.display = "none"; // hide
      }
    });
  });

  // Auto-resize function with min + max height (‚âà 5 lines)
  function autoResizeTextarea(el) {
    el.style.height = "auto"; // reset so scrollHeight is accurate

    const lineHeight = 20; // adjust to match your textarea CSS line-height
    const minHeight = lineHeight * 2;  // ~2 lines minimum
    const maxHeight = lineHeight * 5;  // ~5 lines maximum

    const newHeight = Math.min(el.scrollHeight, maxHeight);

    el.style.height = newHeight + "px";

    // Enable vertical scrollbar only if content exceeds maxHeight
    el.style.overflowY = el.scrollHeight > maxHeight ? "auto" : "hidden";
  }

  // Resize on input
  chatInput.addEventListener("input", () => autoResizeTextarea(chatInput));

  // Make Enter = newline only
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      const { selectionStart, selectionEnd } = chatInput;

      chatInput.value =
        chatInput.value.substring(0, selectionStart) +
        "\n" +
        chatInput.value.substring(selectionEnd);

      chatInput.selectionStart = chatInput.selectionEnd = selectionStart + 1;
      autoResizeTextarea(chatInput);
    }
  });

  // Send only with Send button
  sendButton.addEventListener("click", (e) => {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (text) {
      sendMessage(text);
      chatInput.value = ""; // clear input
      autoResizeTextarea(chatInput); // reset height
    }
  });

  // Initial height set
  autoResizeTextarea(chatInput);

  // Attach Guest from Guest List page
  const guestData = localStorage.getItem("attachGuest");
  if (guestData) {
    createGuestPreview(JSON.parse(guestData));
    localStorage.removeItem("attachGuest"); // clear after use
  }

});
</script>

{% endblock %}