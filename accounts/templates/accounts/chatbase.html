{% load static %}
{% load user_avatar_tags %}
{% load guest_avatar_tags %}
{% load widget_tweaks %}
{% load group_tags %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Gateway Magnet{% endblock %}</title>

  <!-- PWA manifest and theme color -->
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <meta name="theme-color" content="#2e303e">

  <!-- Apple support -->
  <link rel="apple-touch-icon" href="{% static 'images/icons/icon-192x192.png' %}">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'images/icons/icon-192x192.png' %}">
  <link rel="icon" type="image/png" sizes="512x512" href="{% static 'images/icons/icon-512x512.png' %}">
  <link rel="icon" type="image/png" sizes="512x512" href="{% static 'images/icons/icon-512x512-maskable.png' %}">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <!--<link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css" rel="stylesheet" />-->
  <link href="{% static 'vendor/tabler/tabler.min.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont/tabler-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <link href="{% static 'css/custom.css' %}" rel="stylesheet" />

  <script src="{% static 'js/tabler-theme-dark.js' %}"></script>

  {% block extra_css %}{% endblock %}

</head>
<body class="min-vh-100" data-new-gr-c-s-check-loaded="14.1249.0" data-gr-ext-installed="">

  


  <!-- Page Content -->
  <main>
    {% block content %}{% endblock %}
  </main>


  <!-- Install PWA Banner -->
  <div id="installBanner" class="card card-sm fixed-bottom mb-3 mx-3 shadow-lg d-none" style="z-index: 1050;">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <strong>Install Gateway Magnet App</strong><br>
        <small class="text-muted">Get the full experience on your device.</small>
      </div>
      <button id="installBtn" class="btn btn-dark">
        <i class="ti ti-download me-1"></i>Install
      </button>
    </div>
  </div>

  <!-- Notification Settings Modal -->
  <div class="modal fade" id="notifSettingsModal" tabindex="-1" aria-labelledby="notifSettingsLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-3 shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="notifSettingsLabel">Notification Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form id="settingsForm" method="post">
          <div class="modal-body">
            {% csrf_token %}

            <!-- Notification Sound Selector -->
            <div class="mb-3">
              <label class="form-label">Notification Sound</label>
              <div class="list-group">
                {% for value,label in sound_choices %}
                <label class="list-group-item d-flex align-items-center">
                  <input type="radio"
                        name="notification_sound"
                        value="{{ value }}"
                        {% if settings and settings.notification_sound == value %}checked{% endif %}
                        class="me-2">
                  <span class="flex-grow-1">{{ label }}</span>
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm preview-btn"
                          data-sound="{{ value }}">
                    ▶
                  </button>
                </label>
                {% endfor %}
              </div>
            </div>

            <!-- Vibration Toggle -->
            <div class="form-check mb-3">
              <input type="checkbox"
                    name="vibration_enabled"
                    id="vibration_enabled"
                    {% if settings and settings.vibration_enabled %}checked{% endif %}
                    class="form-check-input">
              <label for="vibration_enabled" class="form-check-label">Enable Vibration</label>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>

        <!-- Hidden audio elements -->
        <audio id="notifSound" preload="auto"></audio>
        <audio id="previewSound" preload="auto"></audio>
      </div>
    </div>
  </div>

  <!-- JS: Map sound keys → static URLs & URLs -->
  <script>
    window.APP_CONFIG = {
      urls: {
        topServicesData: "{% url 'top_services_data' %}",
        channelBreakdown: "{% url 'channel_breakdown' %}",
        updateSettings: "{% url 'notifications:update_user_settings' %}",
        markAllRead: "{% url 'notifications:mark_all_read' %}"
      },
      csrfToken: "{{ csrf_token }}",
      user: {
        id: {{ request.user.id|default:'null' }},
        isAuthenticated: {{ request.user.is_authenticated|yesno:'true,false' }},
      },
      sound: {
        userSound: "{{ settings.notification_sound|default:'chime1' }}",
        vibrationEnabled: {{ settings.vibration_enabled|yesno:'true,false' }},
        soundMap: {
          {% for value,label in sound_choices %}
          "{{ value }}": "{% static 'sounds/' %}{{ value }}.mp3"{% if not forloop.last %},{% endif %}
          {% endfor %}
        }
      }
    };
  </script>

  <!-- Attendance Modal -->
  <div class="modal modal-blur fade" id="attendanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h3 class="modal-title">Mark Attendance</h3>
        </div>

        <form id="attendanceForm" method="POST" action="{% url 'mark_attendance' %}">
          {% csrf_token %}
          <div class="modal-body">
            <p class="text-muted mb-3">
              Please mark your presence or follow-up for this event.
            </p>

            <!-- Hidden event info -->
            <input type="hidden" name="event_id" id="eventIdField">
            <input type="hidden" name="custom_event" id="customEventName">
            <input type="hidden" name="next" value="{{ request.META.HTTP_REFERER }}">

            <!-- Read-only Event Display -->
            <div class="mb-3">
              <label class="form-label">Event</label>
              <input type="text" id="eventDisplayName" class="form-control"
                    readonly
                    style="background-color: #111827; color:#fff; border:none;">
            </div>

            <div class="mb-3">
              <label class="form-label">Remarks (optional)</label>
              <textarea name="remarks" class="form-control"
                        placeholder="E.g. Attended virtually, followed up guest..."
                        style="background-color: #111827; color:#fff; border:none; height:100px;"></textarea>
            </div>

            <div class="mb-3" id="statusWrapper">
              <label class="form-label">Attendance Status</label>
              <select name="status" id="statusSelect" class="form-select" required
                      style="background-color: #111827; color:#fff; border:none;">
                <option value="" disabled selected>-- Choose status --</option>
                <option value="present">Present</option>
                <option value="excused">Excused</option>
                <option value="absent">Absent</option>
              </select>
            </div>

            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">
          </div>

          <div class="modal-footer border-0 d-flex justify-content-between">
            <button type="submit" class="btn btn-primary" style="background-color:#0078d7; border:none;">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const modalEl = document.getElementById("attendanceModal");
    const attendanceModal = new bootstrap.Modal(modalEl, { backdrop: "static", keyboard: false });
    const eventDisplayName = document.getElementById("eventDisplayName");
    const eventIdField = document.getElementById("eventIdField");
    const customEventName = document.getElementById("customEventName");
    const attendanceForm = document.getElementById("attendanceForm");
    const nextField = attendanceForm.querySelector('input[name="next"]');

    let modalOpen = false;

    // --- Capture current URL for redirect fallback ---
    nextField.value = window.location.href;

    // --- Geolocation capture ---
    let locationReady = false;
    function captureLocation() {
      if (!navigator.geolocation) {
        console.warn("Geolocation not supported");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          console.log("✅ Location captured:", pos.coords);
          document.getElementById("latitude").value = pos.coords.latitude;
          document.getElementById("longitude").value = pos.coords.longitude;
          locationReady = true;
        },
        (err) => {
          console.warn("⚠️ Location access denied:", err.message);
          locationReady = false;
        }
      );
    }

    // --- WebSocket connection ---
    const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws/attendance/`);

    ws.onopen = () => console.log("✅ WebSocket connected for attendance");
    // --- Check for recent event when user logs in ---
    async function checkRecentEvent(retry = 0) {
      try {
        const res = await fetch("/accounts/attendance/recent/", {
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });

        const contentType = res.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          throw new Error("Not JSON");
        }

        const data = await res.json();
        if (data.event && data.event.id) {
          openAttendanceModal(data.event);
        } else {
          console.log("No active event within 45-minute window");
        }
      } catch (err) {
        if (retry < 3) {
          console.warn(`Retrying recent event check (${retry + 1})...`);
          setTimeout(() => checkRecentEvent(retry + 1), 500);
        } else {
          console.warn("No recent event found after retries:", err);
        }
      }
    }

    // Trigger check when page loads (after small delay)
    setTimeout(checkRecentEvent, 500);

    ws.onclose = () => console.warn("⚠️ WebSocket disconnected");
    ws.onerror = (err) => console.error("WebSocket error:", err);

    // --- Open modal when event broadcast received ---
    function openAttendanceModal(event) {
      if (modalOpen) return;
      modalOpen = true;

      modalEl.querySelector(".modal-title").textContent = `Mark Attendance for ${event.name}`;
      eventDisplayName.value = event.name;
      eventIdField.value = event.id;
      customEventName.value = event.name;

      attendanceModal.show();
      captureLocation();
      modalEl.addEventListener("hidden.bs.modal", () => (modalOpen = false), { once: true });
    }

    // --- WebSocket message handler ---
    ws.onmessage = function (e) {
      const data = JSON.parse(e.data);

      // 🔹 Event broadcast
      if (data.id && data.name) {
        const now = new Date();
        const eventTime = new Date(`${data.date}T${data.time}`);
        const diffMinutes = Math.abs((eventTime - now) / 60000);
        if (diffMinutes >= -1 && diffMinutes <= 45) openAttendanceModal(data);
      }

      // 🔹 Summary broadcast (live table update)
      if (data.records) {
        updateAttendanceSummary(data.records);
      }
    };

    // --- AJAX form submission ---
    attendanceForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!locationReady) {
        e.preventDefault();
        showToast("📍 Waiting for your location... please allow access.", "warning");
        captureLocation();
        return;
      }
      const formData = new FormData(attendanceForm);
      const submitBtn = attendanceForm.querySelector("button[type='submit']");
      submitBtn.disabled = true;
      submitBtn.textContent = "Saving...";

      try {
        const response = await fetch(attendanceForm.action, {
          method: "POST",
          headers: { "X-Requested-With": "XMLHttpRequest" },
          body: formData,
        });
        const data = await response.json();

        if (data.success) {
          attendanceModal.hide();
          showToast("✅ " + data.message, "success", 4000);

          // 🧩 Local fallback refresh if websocket delay
          await refreshAttendanceSummary();
        } else {
          showToast("⚠️ " + (data.error || "Failed to mark attendance"), "warning", 8000, true);
          // Optional: shake effect to emphasize
          modalEl.classList.add("shake");
          setTimeout(() => modalEl.classList.remove("shake"), 600);
        }
      } catch (err) {
        console.error(err);
        showToast("❌ Error submitting attendance", "danger");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit";
      }
    });

    // --- Helper: Refresh summary via AJAX (fallback) ---
    async function refreshAttendanceSummary() {
      try {
        const res = await fetch("/accounts/attendance/summary/", { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await res.json();
        if (data.records) updateAttendanceSummary(data.records);
      } catch (err) {
        console.warn("Could not refresh summary:", err);
      }
    }

    // --- Helper: Update summary table ---
    function updateAttendanceSummary(records) {
      const tbody = document.querySelector("#attendanceTableBody");
      if (!tbody) return;
      tbody.innerHTML = records.map((r) => `
        <tr>
          <td>${r.date}</td>
          <td>${r.event}</td>
          <td>${r.user}</td>
          <td>
            ${
              r.status === "present"
                ? `<span class="badge bg-success-lt">Present</span>`
                : r.status === "late"
                ? `<span class="badge bg-danger-lt">Late</span>`
                : r.status === "excused"
                ? `<span class="badge bg-warning-lt">Excused</span>`
                : `<span class="badge bg-secondary-lt">Absent</span>`
            }
          </td>
          <td>${r.remarks || "—"}</td>
        </tr>`).join("");
    }

    // --- Helper: Show toast ---
    function showToast(message, type = "info", duration = 6000, insideModal = false) {
      const toast = document.createElement("div");
      toast.className = `alert alert-${type} text-center fade show fw-semibold`;
      toast.role = "alert";
      toast.style.marginTop = "1rem";
      toast.style.transition = "opacity 0.3s ease";

      toast.innerHTML = `
        <div>${message}</div>
      `;

      if (insideModal) {
        const modalBody = document.querySelector("#attendanceModal .modal-body");
        if (modalBody) {
          // Insert toast at the bottom of the modal
          modalBody.appendChild(toast);
          toast.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      } else {
        // fallback — screen toast
        toast.classList.add("position-fixed", "bottom-0", "end-0", "m-3");
        toast.style.zIndex = 9999;
        document.body.appendChild(toast);
      }

      setTimeout(() => {
        toast.classList.remove("show");
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 400);
      }, duration);
    }
  });
  </script>

  <!-- ========================= -->
  <!-- JS LIBRARIES -->
  <!-- ========================= -->
  <script src="https://unpkg.com/htmx.org@1.9.3"></script>
  <!-- FullCalendar (global builds) -->
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const navbar = document.querySelector(".navbar");
      window.addEventListener("scroll", function () {
        if (window.scrollY > 50) {
          navbar.classList.add("scrolled");
        } else {
          navbar.classList.remove("scrolled");
        }
      });
    });
  </script>

  <!-- ========================= -->
  <!-- CUSTOM SCRIPTS -->
  <!-- ========================= -->
  <!-- Inject VAPID public key into global JS scope -->
  <script>
    window.VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY|escapejs }}";
    console.log("Injected VAPID key:", window.VAPID_PUBLIC_KEY, "Length:", window.VAPID_PUBLIC_KEY.length);
  </script>

  <script src="{% static 'js/custom.js' %}"></script>  
  
  {% block extra_js %}{% endblock %}

</body>
</html>