{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load user_avatar_tags %}

{% block content %}
<div class="page page-center">
  <div class="container container-tight py-4">

    <!-- Edit User Card -->
    <div class="card card-md bg-dark text-white border border-secondary">
      <div class="card-body text-center">

        <!-- Editable User Avatar -->
        <label for="id_picture" class="cursor-pointer" style="display:inline-block; position:relative;">
          {% if profile_form.instance.picture %}
            <span id="avatar-preview" 
                  class="avatar avatar-xl rounded" 
                  style="background-image: url('{{ profile_form.instance.picture.url }}'); width:96px; height:96px; background-size:cover; background-position:center;">
            </span>
          {% else %}
            <span id="avatar-preview" 
                  class="avatar avatar-xl rounded bg-secondary d-inline-flex align-items-center justify-content-center"
                  style="width:96px; height:96px; font-size:32px; font-weight:bold;">
              {{ user.profile.initials|default:"+" }}
            </span>
          {% endif %}
          <input type="file" id="id_picture" name="picture" accept="image/*" class="d-none">
        </label>

        <small class="text-muted d-block mt-1">(Click avatar to change)</small>

        <h3 class="mt-3">Edit User: {{ user.profile.full_name|default:user.username }}</h3>

        <!-- Edit Form -->
        <form method="post" enctype="multipart/form-data" class="mt-3 text-start">
          {% csrf_token %}

          <!-- User Form Fields -->
          {% for field in user_form %}
          <div class="mb-3">
              <label class="form-label">{{ field.label }}</label>
              {% with ph="placeholder:"|add:field.label %}
              {{ field|add_class:"form-control bg-dark text-white border-secondary"|attr:ph }}
              {% endwith %}
              {% if field.errors %}
              <div class="text-danger small">{{ field.errors|striptags }}</div>
              {% endif %}
          </div>
          {% endfor %}

          <!-- Profile Form Fields -->
          {% for field in profile_form %}
          <div class="mb-3">
              <label class="form-label">{{ field.label }}</label>
              {% with ph="placeholder:"|add:field.label %}
              {{ field|add_class:"form-control bg-dark text-white border-secondary"|attr:ph }}
              {% endwith %}
              {% if field.errors %}
              <div class="text-danger small">{{ field.errors|striptags }}</div>
              {% endif %}
          </div>
          {% endfor %}

          <!-- Additional Form Fields -->
          {% for field in form %}
          <div class="mb-3">
              <label class="form-label">{{ field.label }}</label>
              {% with ph="placeholder:"|add:field.label %}
              {{ field|add_class:"form-control bg-dark text-white border-secondary"|attr:ph }}
              {% endwith %}
              {% if field.errors %}
              <div class="text-danger small">{{ field.errors|striptags }}</div>
              {% endif %}
          </div>
          {% endfor %}

          <!-- Buttons -->
          <div class="form-footer mt-4">
            <button type="submit" class="btn btn-success w-100">Save Changes</button>
            <a href="{% url 'user_list' %}" class="btn btn-secondary w-100 mt-2">Back</a>
          </div>
        </form>

        {% if request.user.is_superuser %}
        <div class="mt-3">
        <button class="btn btn-warning w-100" 
            data-bs-toggle="modal" 
            data-bs-target="#password-modal"
            hx-get="{% url 'change_user_password' user.pk %}" 
            hx-target="#password-modal-body" 
            hx-swap="innerHTML">
          Change User Password
        </button>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="password-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content" id="password-modal-body">
          <!-- Password form will load here via htmx -->
          </div>
        </div>
        </div>
        {% endif %}

        <!-- Delete User Button -->
        <div class="mt-3">
          <form method="post" action="{% url 'delete_user' user.pk %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger w-100"
                    onclick="return confirm('Are you sure you want to delete this user?')">
              Delete User
            </button>
          </form>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Live Avatar Preview Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const fileInput = document.getElementById("id_picture");
  const preview = document.getElementById("avatar-preview");

  if (fileInput) {
    fileInput.addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.style.backgroundImage = `url('${e.target.result}')`;
          preview.textContent = "";
          preview.classList.remove("bg-secondary");
        };
        reader.readAsDataURL(file);
      }
    });
  }
});
</script>
{% endblock %}
