{#
{% extends 'base.html' %}
{% load group_tags %}
{% load static %}
{% load humanize %}
{% block content %}


<div class="page-wrapper">
  <!-- BEGIN PAGE HEADER -->
  <div class="page-header d-print-none" aria-label="Page header">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Dynamic Page Title -->
          <kbd class="bg-indigo-lt"><h2 class="page-title">{{ page_title }}</h2></kbd>
        </div>
      </div>
    </div>
  </div>
  <!-- END PAGE HEADER -->


  <div class="page-body">
    <div class="container-xl flex-fill d-flex flex-column">
      <div class="card flex-fill">
        <div class="row g-0 flex-fill">
          <div class="col-12 col-lg-5 col-xl-3 border-end d-flex flex-column">
            <div class="card-header mb-2 me-2 d-flex justify-content-center align-items-center">
              <!-- Avatar -->
              <span class="avatar avatar-lg bg-purple-lt d-flex align-items-center justify-content-center" style="width:34px; height:34px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-armchair">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M5 11a2 2 0 0 1 2 2v2h10v-2a2 2 0 1 1 4 0v4a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-4a2 2 0 0 1 2 -2z" />
                  <path d="M5 11v-5a3 3 0 0 1 3 -3h8a3 3 0 0 1 3 3v5" />
                  <path d="M6 19v2" /><path d="M18 19v2" />
                </svg>
              </span>

              <!-- Text -->
              <kbd class="ms-2 bg-warning-lt"><h5>A People <em>Helped</em> By God!</h5></kbd>
            </div>
            <div class="card-body mt-2 ps-0 p-2 scrollable ms-0 flex-fill align-items-center justify-content-between" style="height: 800px; overflow-y: auto;">
              <div class="nav flex-column" role="tablist">
                <div class="row g-2 align-items-center flex-column">
                  {% for user in users %}
                    <div class="col-12">
                      <div class="timeline w-auto">
                        <div class="timeline-events list-unstyled">
                          <div class="timeline-event mb-1 w-auto">
                            
                            <!-- Make whole card dropdown trigger -->
                            <a href="#" 
                              class="card dropup timeline-event-card user-card text-white text-decoration-none"
                              id="userDropdown{{ user.id }}" 
                              data-bs-toggle="dropdown" 
                              aria-expanded="false"
                              data-userid="{{ user.id }}"
                              data-phone="{{ user.phone_number|default:'' }}"
                              data-can-view-guests="{% if request.user|has_group:'Pastor,Team Lead,Admin' or guest.assigned_to == request.user %}true{% else %}false{% endif %}">
                              <div class="card-body d-flex align-items-center gap-2">
                                
                                {% if user.image %}
                                  <span class="avatar avatar-1 rounded mx-1"
                                        style="background-image: url('{{ user.image.url }}');
                                              display:inline-block; width:36px; height:36px;
                                              background-size:cover; background-position:center;
                                              margin-right:6px; box-shadow:0 2px 8px #15945433;">
                                  </span>
                                {% else %}
                                  <span class="avatar avatar-1 bg-grey text-white d-inline-flex align-items-center justify-content-center rounded"
                                        style="width:36px; height:36px; font-weight:bold; font-size:16px; 
                                              margin-right:6px; box-shadow:0 2px 8px #15945433;">
                                    {{ user.initials }}
                                  </span>
                                {% endif %}
                                
                                <h4 class="mb-1">{{ user.title|default:'' }} {{ user.full_name }}</h4>
                              </div>
                              <!-- Long press overlay -->
                              <div class="user-card-longpress-overlay"></div>
                            </a>

                            <!-- Dropdown menu -->
                            <ul class="dropdown-menu" aria-labelledby="userDropdown{{ user.id }}">
                              {% for guest in user.assigned_guests.all %}
                                {% if request.user|has_group:"Pastor,Team Lead,Admin" or guest.assigned_to == request.user or guest.full_name == "Wunmi Jordan" %}
                                  <li>
                                    <a href="#" class="dropdown-item guest-item" 
                                      data-userid="{{ user.id }}"
                                      data-guestid="{{ guest.id }}"
                                      data-title="{{ guest.title }}"
                                      data-fullname="{{ guest.full_name }}"
                                      data-phone="{{ guest.phone_number }}"
                                      data-picture="{{ guest.picture.url|default:'' }}"
                                      data-customid="{{ guest.custom_id }}"
                                      data-date="{{ guest.date_of_visit|date:'Y-m-d' }}">
                                      {{ guest.full_name }}
                                    </a>
                                  </li>
                                {% endif %}
                              {% endfor %}
                            </ul>

                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-7 col-xl-9 d-flex flex-column">
            <div class="card-header justify-content-center mb-2">
              <div class="input-icon">
                <span class="input-icon-addon">
                  <!-- Download SVG icon from http://tabler.io/icons/icon/search -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path>
                    <path d="M21 21l-6 -6"></path>
                  </svg>
                </span>
                <input type="text" id="chatSearchInput" value="" class="form-control" placeholder="Search Chat" aria-label="Search">
              </div>
            </div>
            <div class="card-body" style="height: 800px; overflow-y: auto;">
              <div class="chat-messages flex-grow-1 overflow-auto mb-4 text-end ms-4 me-2" id="chatMessagesContainer">
                {% if chat_messages %}
                  
                  <!-- ChatBody Render with JS -->                  

                {% endif %}
              </div>     
              
              <!-- Attachment preview area -->
              <div id="attachmentPreview" class="mt-2"></div>

              <!-- Reply indicator -->
              <div id="replyIndicator" class="mb-2 ms-4 me-1 reply-preview text-white px-2 py-1 rounded-2 justify-content-between align-items-center" 
                    style="border-left: 8px solid #018f14ff; background-color: #93db9d34; 
                          display:none; font-style: normal; box-shadow: 0 4px 8px #0000004d;">
                <span id="replyToName"></span>
                <button type="button" id="clearReplyBtn" class="btn p-0 border-0 d-flex align-items-center justify-content-center" style="width:16px; height:16px;">
                  <!-- Cancel SVG -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Chat form -->
            <form id="chatReplyForm" class="d-flex ms-6 me-6 mt-1 mb-4">
              {% csrf_token %}
              <input type="hidden" name="parent_id" id="replyToId">
              <div class="d-flex flex-column w-100">

                <!-- Textarea and buttons -->
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <textarea id="chatInput" rows="1" class="form-control border-0 flex-grow-1 me-2" style="width: 200px;" placeholder="Type Message" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px';"></textarea>
                  <div class="d-flex align-items-center">

                    <!-- Guest card attachment
                    <button type="button" id="guestAttachmentBtn" class="avatar bg-gray-lt border-0 me-2 text-white p-1 d-flex align-items-center justify-content-center" title="Attach Guest Card">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-user-search">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                        <path d="M6 21v-2a4 4 0 0 1 4 -4h1.5" /><path d="M18 18m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                        <path d="M20.2 20.2l1.8 1.8" />
                      </svg>
                    </button>
                    -->

                    <!-- Device file attachment -->
                    {% if request.user.is_superuser %}
                      <label for="fileAttachment" class="avatar bg-gray-lt border-0 me-2 text-purple p-1 d-flex align-items-center justify-content-center" title="Attach File">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                          <path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5"/>
                        </svg>
                      </label>
                      <input type="file" id="fileAttachment" class="d-none">
                    {% endif %}

                    <!-- Send button -->
                    <button type="submit" id="sendChatBtn" class="avatar bg-gray-lt border-0 text-green p-1 d-flex align-items-center justify-content-center">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M4.698 4.034l16.302 7.966l-16.302 7.966a.503 .503 0 0 1 -.546 -.124a.555 .555 0 0 1 -.12 -.568l2.468 -7.274l-2.468 -7.274a.555 .555 0 0 1 .12 -.568a.503 .503 0 0 1 .546 -.124z" />
                        <path d="M6.5 12h14.5" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Guest Detail Modal -->
<div class="modal fade modal-blur" id="chatGuestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header align-items-center justify-content-center">
        <h2 class="modal-title text-warning">GUEST DETAILS</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="chatGuestModalBody">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>
</div>






<script>
  window.chatUrls = {
    send: "{% url 'accounts:send_chat_message' %}",
    fetch: "{% url 'accounts:fetch_chat_messages' %}"
  };
  window.currentUserId = {{ request.user.id }};
</script>


{% endblock %}
#}